"use strict";(()=>{var e={};e.id=328,e.ids=[328],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},7790:e=>{e.exports=require("assert")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},665:e=>{e.exports=require("dns")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},4026:e=>{e.exports=require("string_decoder")},2452:e=>{e.exports=require("tls")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},4557:(e,t,n)=>{n.r(t),n.d(t,{GlobalError:()=>i.a,__next_app__:()=>p,originalPathname:()=>u,pages:()=>d,routeModule:()=>h,tree:()=>c}),n(7406),n(2029),n(5866);var o=n(3191),r=n(8716),s=n(7922),i=n.n(s),l=n(5231),a={};for(let e in l)0>["default","tree","pages","GlobalError","originalPathname","__next_app__","routeModule"].indexOf(e)&&(a[e]=()=>l[e]);n.d(t,a);let c=["",{children:["questions",{children:["queue",{children:["__PAGE__",{},{page:[()=>Promise.resolve().then(n.bind(n,7406)),"D:\\tests techno 130 ans EMF\\src\\app\\questions\\queue\\page.tsx"]}]},{}]},{}]},{layout:[()=>Promise.resolve().then(n.bind(n,2029)),"D:\\tests techno 130 ans EMF\\src\\app\\layout.tsx"],"not-found":[()=>Promise.resolve().then(n.t.bind(n,5866,23)),"next/dist/client/components/not-found-error"]}],d=["D:\\tests techno 130 ans EMF\\src\\app\\questions\\queue\\page.tsx"],u="/questions/queue/page",p={require:n,loadChunk:()=>Promise.resolve()},h=new o.AppPageRouteModule({definition:{kind:r.x.APP_PAGE,page:"/questions/queue/page",pathname:"/questions/queue",bundlePath:"",filename:"",appPaths:[]},userland:{loaderTree:c}})},7406:(e,t,n)=>{let o,r;n.r(t),n.d(t,{default:()=>p});var s=n(9510),i=n(6005),l=n(3061),a=n(9534),c=n(2898);let d=`
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  .page {
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    background: #f3f4f6;
  }
  .card {
    background: #ffffff;
    border-radius: 12px;
    padding: 32px 28px;
    box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    width: 100%;
    max-width: 640px;
    text-align: center;
  }
  h1 {
    font-size: 24px;
    margin: 0 0 16px 0;
    color: #111827;
  }
  .question {
    font-size: 17px;
    color: #4b5563;
    margin-bottom: 16px;
  }
  .position {
    font-size: 22px;
    font-weight: 600;
    color: #2563eb;
    margin-bottom: 8px;
  }
  .time {
    font-size: 16px;
    color: #6b7280;
  }
  .info {
    margin-top: 16px;
    font-size: 14px;
    color: #6b7280;
  }
  button {
    margin-top: 20px;
    padding: 12px 18px;
    border: none;
    border-radius: 999px;
    background: #e5e7eb;
    color: #111827;
    cursor: pointer;
    font-size: 15px;
    transition: background-color 0.15s ease;
  }
  button:hover {
    background: #d1d5db;
  }
`,u={fr:{missing:"Identifiant utilisateur manquant. Merci de recommencer.",fallbackTitle:"File en pr\xe9paration",fallbackBody:"Redis n’est pas disponible pour le moment. Revenez plus tard.",queueTitle:"Votre question est en attente",refresh:"⟳ Cette page se rafra\xeechit automatiquement toutes les 5 secondes.",back:"← Retour au d\xe9but"},de:{missing:"Benutzer-ID fehlt. Bitte erneut starten.",fallbackTitle:"Warteschlange wird vorbereitet",fallbackBody:"Redis ist momentan nicht verf\xfcgbar. Bitte versuchen Sie es sp\xe4ter erneut.",queueTitle:"Ihre Frage wartet noch",refresh:"⟳ Diese Seite aktualisiert sich alle 5 Sekunden automatisch.",back:"← Zur\xfcck zum Start"}};async function p({searchParams:e}){(0,l.l)();let t=e.userId,n=e.lang,p=e.category,h=e.questionId,g=e.clientip,x=e.clientmac,m="de"===n?"de":"fr",f=u[m];if(!t&&n&&p&&h){let e="de"===n?"de":"fr"===n?"fr":void 0;if(e){let t=c[e]?.[p];if(t){let n=t.find(e=>e.id===h);if(n){let t=function(e=21){var t;t=e|=0,!o||o.length<t?(o=Buffer.allocUnsafe(128*t),i.webcrypto.getRandomValues(o),r=0):r+t>o.length&&(i.webcrypto.getRandomValues(o),r=0),r+=t;let n="";for(let t=r-e;t<r;t++)n+="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict"[63&o[t]];return n}(10),l={id:h,question:n.question,reponse_detaillee:n.reponse_detaillee,lang:e,category:p,timestamp:new Date().toISOString(),userId:t};await (0,a.u0)(async()=>{if(!a.T8)throw Error("Redis client not initialized");return console.log("[REDIS] Attempting to add entry to queue (from list)..."),await a.T8.rpush("questions:queue",JSON.stringify(l)),console.log("[REDIS] Successfully added to queue (from list):",l),!0},!1,"RPUSH questions:queue (from list)"),console.log(`[QUEUE] Created entry from list - Lang: ${e}, Category: ${p}, QuestionId: ${h}, UserId: ${t}`);let c=new URLSearchParams({userId:t,lang:e});g&&c.append("clientip",g),x&&c.append("clientmac",x);let u=`/questions/queue?${c.toString()}`;return(0,s.jsxs)("html",{children:[(0,s.jsxs)("head",{children:[s.jsx("meta",{charSet:"utf-8"}),s.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),s.jsx("meta",{httpEquiv:"refresh",content:`0; url=${u}`}),s.jsx("title",{children:"Redirection file d'attente"}),s.jsx("style",{children:d})]}),s.jsx("body",{children:s.jsx("div",{className:"page",children:(0,s.jsxs)("div",{className:"card",children:[s.jsx("h1",{children:f.queueTitle}),s.jsx("p",{className:"question",children:"Pr\xe9paration de votre file d'attente…"})]})})})]})}console.error(`[QUEUE] Question not found on initial arrival: ${h}`)}else console.error(`[QUEUE] Invalid category on initial arrival: ${p} for lang: ${e}`)}else console.error("[QUEUE] Invalid lang on initial arrival:",n)}if(!t)return(0,s.jsxs)("html",{children:[(0,s.jsxs)("head",{children:[s.jsx("meta",{charSet:"utf-8"}),s.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),s.jsx("meta",{httpEquiv:"refresh",content:"5"}),s.jsx("title",{children:"File d'attente"}),s.jsx("style",{children:d})]}),s.jsx("body",{children:s.jsx("div",{className:"page",children:(0,s.jsxs)("div",{className:"card",children:[s.jsx("h1",{children:f.fallbackTitle}),s.jsx("p",{className:"question",children:f.missing}),s.jsx("form",{method:"GET",action:"/questions",children:s.jsx("button",{type:"submit",children:f.back})})]})})})]});let E=(await (0,a.u0)(async()=>{if(!a.T8)throw Error("Redis client not initialized");return a.T8.lrange("questions:queue",0,-1)},[],"LRANGE questions:queue")).map(e=>{try{return JSON.parse(e)}catch{return null}}).filter(e=>!!e);if(!a.jJ||0===E.length)return console.warn("[QUEUE] Redis unavailable or queue empty"),(0,s.jsxs)("html",{children:[(0,s.jsxs)("head",{children:[s.jsx("meta",{charSet:"utf-8"}),s.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),s.jsx("meta",{httpEquiv:"refresh",content:"5"}),s.jsx("title",{children:"File d'attente"}),s.jsx("style",{children:d})]}),s.jsx("body",{children:s.jsx("div",{className:"page",children:(0,s.jsxs)("div",{className:"card",children:[s.jsx("h1",{children:f.fallbackTitle}),s.jsx("p",{className:"question",children:f.fallbackBody}),s.jsx("form",{method:"GET",action:"/questions",children:s.jsx("button",{type:"submit",children:f.back})})]})})})]});let R=E.findIndex(e=>e.userId===t)+1,j=E.length,y=E.find(e=>e.userId===t);if(console.log(`[QUEUE] UserId: ${t}, Queue length: ${E.length}`),!y||0===R)return console.warn("[QUEUE] Entry not found for userId",t),(0,s.jsxs)("html",{children:[(0,s.jsxs)("head",{children:[s.jsx("meta",{charSet:"utf-8"}),s.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),s.jsx("meta",{httpEquiv:"refresh",content:"5"}),s.jsx("title",{children:"File d'attente"}),s.jsx("style",{children:d})]}),s.jsx("body",{children:s.jsx("div",{className:"page",children:(0,s.jsxs)("div",{className:"card",children:[s.jsx("h1",{children:f.fallbackTitle}),s.jsx("p",{className:"question",children:f.missing}),s.jsx("form",{method:"GET",action:"/questions",children:s.jsx("button",{type:"submit",children:f.back})})]})})})]});let q=30*R;if(console.log(`[QUEUE] Position: ${R}/${j}, Estimated time: ${q}s`),1===R){console.log(`[QUEUE] User ${t} reached position 1 - redirecting`);let e=new URLSearchParams({userId:t,lang:m});g&&e.append("clientip",g),x&&e.append("clientmac",x);let n=e.toString(),o=`/questions/display?${n}`;return console.log("[QUEUE] Redirecting to display:",o),(0,s.jsxs)("html",{children:[(0,s.jsxs)("head",{children:[s.jsx("meta",{charSet:"utf-8"}),s.jsx("meta",{httpEquiv:"refresh",content:`0; url=${o}`}),s.jsx("title",{children:"C'est votre tour"}),s.jsx("style",{children:d})]}),s.jsx("body",{children:s.jsx("div",{className:"page",children:(0,s.jsxs)("div",{className:"card",children:[s.jsx("h1",{children:"\uD83C\uDF89 C'est votre tour !"}),s.jsx("p",{className:"question",children:"Redirection..."})]})})})]})}return(0,s.jsxs)("html",{children:[(0,s.jsxs)("head",{children:[s.jsx("meta",{charSet:"utf-8"}),s.jsx("meta",{name:"viewport",content:"width=device-width, initial-scale=1.0"}),s.jsx("meta",{httpEquiv:"refresh",content:"5"}),s.jsx("title",{children:"File d'attente"}),s.jsx("style",{children:d})]}),s.jsx("body",{children:s.jsx("div",{className:"page",children:(0,s.jsxs)("div",{className:"card",children:[s.jsx("h1",{children:f.queueTitle}),(0,s.jsxs)("p",{className:"question",children:["\xab ",y.question," \xbb"]}),(0,s.jsxs)("div",{className:"position",children:[R," / ",j]}),(0,s.jsxs)("div",{className:"time",children:["Temps estim\xe9 : ~",Math.floor(q/60)," min ",q%60," sec"]}),s.jsx("div",{className:"info",children:f.refresh})]})})})]})}},3676:(e,t,n)=>{n.d(t,{c:()=>s});let o=process.env.NUMBER_DISPLAY_URL||"http://192.168.2.130/data",r=process.env.NUMBER_DISPLAY_TOKEN||"";async function s(e){if(!o)return console.warn("[NUM-DISPLAY] ⚠️ No URL configured, SKIPPING"),!1;if(!r)return console.warn("[NUM-DISPLAY] ⚠️ No token configured (NUMBER_DISPLAY_TOKEN env var), SKIPPING"),!1;let t=Math.max(0,Math.min(255,Number.isFinite(e)?Math.trunc(e):255)),n=`token=${encodeURIComponent(r)}&datain=${t}`;console.log("[NUM-DISPLAY] Sending request:",{url:o,id:t,bodyLength:n.length});try{let e=await fetch(o,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:n,signal:AbortSignal.timeout(3e3)}),t=await e.text().catch(()=>"");if(!e.ok)return console.error("[NUM-DISPLAY] ❌ HTTP Error:",e.status,t),!1;return console.log("[NUM-DISPLAY] ✓ Response OK:",e.status,t),!0}catch(e){return console.error("[NUM-DISPLAY] ❌ Network error:",e),!1}}console.log("[NUM-DISPLAY] ═══════════════════════════════════════════"),console.log("[NUM-DISPLAY] Configuration:"),console.log("[NUM-DISPLAY]   URL:",o),console.log("[NUM-DISPLAY]   Token configured:",r?"YES ("+r.length+" chars)":"NO ⚠️"),console.log("[NUM-DISPLAY] ═══════════════════════════════════════════")},3061:(e,t,n)=>{n.d(t,{S:()=>R,l:()=>E});var o=n(6005),r=n.n(o),s=n(9534),i=n(3676),l=n(1748);let a="questions:queue";function c(){return globalThis.__queueWorkerState||(globalThis.__queueWorkerState={started:!1,instanceId:"",loopCount:0,lastActivity:0}),globalThis.__queueWorkerState}function d(e){return new Promise(t=>setTimeout(t,Math.max(0,e)))}function u(e){try{return JSON.parse(e)}catch{return null}}async function p(){let e=await (0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");return s.T8.lindex(a,0)},null,"LINDEX");if(!e)return null;let t=u(e);return t?{raw:e,entry:t}:(console.warn("[WORKER] JSON invalide en t\xeate, suppression..."),await (0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");await s.T8.lpop(a)},void 0,"LPOP invalid"),null)}async function h(){return(0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");return s.T8.llen(a)},0,"LLEN")}async function g(){let e=await (0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");return s.T8.lpop(a)},null,"LPOP");return e?u(e):null}async function x(){console.log("[WORKER] ══> Envoi IDLE aux ESP32"),console.log("[WORKER] ══> R\xe9sultat IDLE: WLED="+(await (0,l.z)("ECOLE DES METIERS DE FRIBOURG")?"✓":"✗")+", Display="+(await (0,i.c)(255)?"✓":"✗"))}async function m(e){console.log("[WORKER] ══> Envoi question ID="+e.id+" aux ESP32");let t=e.reponse_detaillee??e.question,n=await (0,l.z)(t),o=parseInt(e.id,10),r=isNaN(o)?255:o;console.log("[WORKER] ══> R\xe9sultat: WLED="+(n?"✓":"✗")+", Display="+(await (0,i.c)(r)?"✓":"✗")+" (ID="+r+")")}async function f(e){let t=c(),n=Date.now(),o=null,r=0;for(console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] Boucle d\xe9marr\xe9e - Instance:",e),console.log("[WORKER] ═══════════════════════════════════════════════════");;){if(t.loopCount++,t.lastActivity=Date.now(),Date.now()-n>1e4){let e=await h();console.log("[WORKER] ♥ Loop #"+t.loopCount+" | File: "+e+" | Affich\xe9: "+(o||"IDLE")),n=Date.now()}try{let e=await p();if(!e){null!==o&&(console.log("[WORKER] File vide d\xe9tect\xe9e"),await x(),o=null,r=0),await d(500);continue}e.entry.id!==o&&(console.log("[WORKER] ────────────────────────────────────────"),console.log("[WORKER] NOUVELLE QUESTION"),console.log("[WORKER] ID: "+e.entry.id),console.log("[WORKER] User: "+e.entry.userId),console.log("[WORKER] ────────────────────────────────────────"),await m(e.entry),o=e.entry.id,r=Date.now(),console.log("[WORKER] Countdown 30s d\xe9marr\xe9"));let t=Date.now()-r;if(3e4-t<=0){console.log("[WORKER] Temps \xe9coul\xe9 pour question ID="+o);let e=await g();e?console.log("[WORKER] ✓ Question supprim\xe9e: ID="+e.id):console.log("[WORKER] ⚠ LPOP retourn\xe9 null");let t=await h();console.log("[WORKER] Questions restantes: "+t),r=0,await d(200)}else await d(500)}catch(e){console.error("[WORKER] ══════════ ERREUR ══════════"),console.error("[WORKER]",e),o=null,r=0,await d(1e3)}}}function E(){let e=c();if(e.started){console.log("[WORKER] D\xe9j\xe0 d\xe9marr\xe9 (instance: "+e.instanceId+")");return}e.started=!0,e.instanceId=`w-${process.pid}-${r().randomBytes(3).toString("hex")}`,console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] ═══════════ D\xc9MARRAGE DU WORKER ═══════════════════"),console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] Instance: "+e.instanceId),console.log("[WORKER] PID: "+process.pid),console.log("[WORKER] Dur\xe9e affichage: 30000ms"),console.log("[WORKER] Intervalle poll: 500ms"),f(e.instanceId)}function R(){let e=c();return{started:e.started,instanceId:e.instanceId,loopCount:e.loopCount,lastActivity:e.lastActivity,lastActivityAgo:e.lastActivity?Date.now()-e.lastActivity:null}}},9534:(e,t,n)=>{n.d(t,{T8:()=>r,jJ:()=>s,u0:()=>i});var o=n(2197);let r=null,s=!1;try{(r=new o.Redis({host:process.env.REDIS_HOST||"localhost",port:parseInt(process.env.REDIS_PORT||"6379",10),retryStrategy:e=>e>3?(console.error("[REDIS] Max retry attempts reached. Redis unavailable."),null):Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("connect",()=>{console.log("[REDIS] Connected successfully"),s=!0}),r.on("error",e=>{console.error("[REDIS ERROR]",e.message),s=!1})}catch(e){console.error("[REDIS] Failed to initialize:",e),r=null,s=!1}async function i(e,t,n){if(!r)return console.warn(`[REDIS FALLBACK] ${n} - Redis client not initialized, using fallback`),t;try{return await e()}catch(e){return console.error(`[REDIS ERROR] ${n} failed:`,e),t}}},1748:(e,t,n)=>{n.d(t,{K:()=>s,z:()=>r});let o=process.env.WLED_URL||"http://192.168.2.120/json/state";async function r(e){if(!o)return console.warn("[WLED] ⚠️ No URL configured, SKIPPING"),!1;let t=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(),n=t.length>64?`${t.slice(0,61).trimEnd()}...`:t;console.log("[WLED] Sending text:",{url:o,text:n,textLength:n.length});try{let e=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({on:!0,bri:255,mainseg:0,seg:[{id:0,start:0,stop:32,startY:0,stopY:8,grp:1,spc:0,of:0,on:!0,frz:!1,bri:255,cct:127,set:0,n:n,col:[[77,166,255],[0,0,0],[0,0,0]],fx:122,sx:200,ix:128,pal:0,c1:0,c2:128,c3:16,sel:!0,rev:!1,mi:!1,rY:!1,mY:!1,tp:!1,o1:!1,o2:!1,o3:!1,si:0,m12:0}]}),signal:AbortSignal.timeout(5e3)}),t=await e.text().catch(()=>"");if(!e.ok)return console.error("[WLED] ❌ HTTP Error:",e.status,t.substring(0,200)),!1;if(console.log("[WLED] ✓ Response OK:",e.status),t)try{let e=JSON.parse(t);console.log("[WLED] Response state:",{on:e.on,bri:e.bri,seg0_n:e.seg?.[0]?.n?.substring(0,30)})}catch{console.log("[WLED] Response (raw):",t.substring(0,100))}return!0}catch(e){return console.error("[WLED] ❌ Network error:",e),!1}}async function s(){let e=o?.replace("/json/state","/json/info");if(!e)return!1;try{let t=await fetch(e,{method:"GET",signal:AbortSignal.timeout(3e3)});if(t.ok){let e=await t.json();return console.log("[WLED] Connection test OK:",{name:e.name,ver:e.ver,ip:e.ip}),!0}return!1}catch{return console.error("[WLED] Connection test FAILED"),!1}}console.log("[WLED] ═══════════════════════════════════════════"),console.log("[WLED] Configuration:"),console.log("[WLED]   URL:",o),console.log("[WLED] ═══════════════════════════════════════════")}};var t=require("../../../webpack-runtime.js");t.C(e);var n=e=>t(t.s=e),o=t.X(0,[276,471,197,553],()=>n(4557));module.exports=o})();
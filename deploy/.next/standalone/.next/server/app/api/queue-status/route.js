"use strict";(()=>{var e={};e.id=570,e.ids=[570],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},7790:e=>{e.exports=require("assert")},8893:e=>{e.exports=require("buffer")},4770:e=>{e.exports=require("crypto")},665:e=>{e.exports=require("dns")},7702:e=>{e.exports=require("events")},2048:e=>{e.exports=require("fs")},8216:e=>{e.exports=require("net")},9801:e=>{e.exports=require("os")},5315:e=>{e.exports=require("path")},6162:e=>{e.exports=require("stream")},4026:e=>{e.exports=require("string_decoder")},2452:e=>{e.exports=require("tls")},4175:e=>{e.exports=require("tty")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},1288:(e,t,o)=>{o.r(t),o.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>g,routeModule:()=>d,serverHooks:()=>D,staticGenerationAsyncStorage:()=>E});var n={};o.r(n),o.d(n,{GET:()=>p,POST:()=>R,runtime:()=>c});var r=o(9303),s=o(8716),i=o(670),l=o(7070),a=o(9534),u=o(3061);let c="nodejs";async function p(){let e=(0,u.S)(),t=(await (0,a.u0)(async()=>{if(!a.T8)throw Error("Redis not initialized");return a.T8.lrange("questions:queue",0,-1)},[],"API queue-status LRANGE")).map(e=>{try{let t=JSON.parse(e);return{id:t.id,userId:t.userId,question:t.question.substring(0,50)+(t.question.length>50?"...":""),timestamp:t.timestamp}}catch{return{invalid:!0,raw:e.substring(0,50)}}});return l.NextResponse.json({timestamp:new Date().toISOString(),redis:{available:a.jJ,host:process.env.REDIS_HOST||"localhost",port:process.env.REDIS_PORT||"6379"},worker:{...e,lastActivityAgoSeconds:e.lastActivityAgo?Math.round(e.lastActivityAgo/1e3):null},queue:{length:t.length,entries:t},config:{wledUrl:process.env.WLED_URL||"http://192.168.2.120/json/state",displayUrl:process.env.NUMBER_DISPLAY_URL||"http://192.168.2.130/data",displayTokenConfigured:!!process.env.NUMBER_DISPLAY_TOKEN}})}async function R(){console.log("[API] Force worker start requested"),(0,u.l)();let e=(0,u.S)();return l.NextResponse.json({message:"Worker start triggered",worker:e})}let d=new r.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/queue-status/route",pathname:"/api/queue-status",filename:"route",bundlePath:"app/api/queue-status/route"},resolvedPagePath:"D:\\tests techno 130 ans EMF\\src\\app\\api\\queue-status\\route.ts",nextConfigOutput:"standalone",userland:n}),{requestAsyncStorage:g,staticGenerationAsyncStorage:E,serverHooks:D}=d,f="/api/queue-status/route";function h(){return(0,i.patchFetch)({serverHooks:D,staticGenerationAsyncStorage:E})}},3676:(e,t,o)=>{o.d(t,{c:()=>s});let n=process.env.NUMBER_DISPLAY_URL||"http://192.168.2.130/data",r=process.env.NUMBER_DISPLAY_TOKEN||"";async function s(e){if(!n)return console.warn("[NUM-DISPLAY] ⚠️ No URL configured, SKIPPING"),!1;if(!r)return console.warn("[NUM-DISPLAY] ⚠️ No token configured (NUMBER_DISPLAY_TOKEN env var), SKIPPING"),!1;let t=Math.max(0,Math.min(255,Number.isFinite(e)?Math.trunc(e):255)),o=`token=${encodeURIComponent(r)}&datain=${t}`;console.log("[NUM-DISPLAY] Sending request:",{url:n,id:t,bodyLength:o.length});try{let e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o,signal:AbortSignal.timeout(3e3)}),t=await e.text().catch(()=>"");if(!e.ok)return console.error("[NUM-DISPLAY] ❌ HTTP Error:",e.status,t),!1;return console.log("[NUM-DISPLAY] ✓ Response OK:",e.status,t),!0}catch(e){return console.error("[NUM-DISPLAY] ❌ Network error:",e),!1}}console.log("[NUM-DISPLAY] ═══════════════════════════════════════════"),console.log("[NUM-DISPLAY] Configuration:"),console.log("[NUM-DISPLAY]   URL:",n),console.log("[NUM-DISPLAY]   Token configured:",r?"YES ("+r.length+" chars)":"NO ⚠️"),console.log("[NUM-DISPLAY] ═══════════════════════════════════════════")},3061:(e,t,o)=>{o.d(t,{S:()=>I,l:()=>h});var n=o(6005),r=o.n(n),s=o(9534),i=o(3676),l=o(1748);let a="questions:queue";function u(){return globalThis.__queueWorkerState||(globalThis.__queueWorkerState={started:!1,instanceId:"",loopCount:0,lastActivity:0}),globalThis.__queueWorkerState}function c(e){return new Promise(t=>setTimeout(t,Math.max(0,e)))}function p(e){try{return JSON.parse(e)}catch{return null}}async function R(){let e=await (0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");return s.T8.lindex(a,0)},null,"LINDEX");if(!e)return null;let t=p(e);return t?{raw:e,entry:t}:(console.warn("[WORKER] JSON invalide en t\xeate, suppression..."),await (0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");await s.T8.lpop(a)},void 0,"LPOP invalid"),null)}async function d(){return(0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");return s.T8.llen(a)},0,"LLEN")}async function g(){let e=await (0,s.u0)(async()=>{if(!s.T8)throw Error("Redis not initialized");return s.T8.lpop(a)},null,"LPOP");return e?p(e):null}async function E(){console.log("[WORKER] ══> Envoi IDLE aux ESP32"),console.log("[WORKER] ══> R\xe9sultat IDLE: WLED="+(await (0,l.z)("ECOLE DES METIERS DE FRIBOURG")?"✓":"✗")+", Display="+(await (0,i.c)(255)?"✓":"✗"))}async function D(e){console.log("[WORKER] ══> Envoi question ID="+e.id+" aux ESP32");let t=e.reponse_detaillee??e.question,o=await (0,l.z)(t),n=parseInt(e.id,10),r=isNaN(n)?255:n;console.log("[WORKER] ══> R\xe9sultat: WLED="+(o?"✓":"✗")+", Display="+(await (0,i.c)(r)?"✓":"✗")+" (ID="+r+")")}async function f(e){let t=u(),o=Date.now(),n=null,r=0;for(console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] Boucle d\xe9marr\xe9e - Instance:",e),console.log("[WORKER] ═══════════════════════════════════════════════════");;){if(t.loopCount++,t.lastActivity=Date.now(),Date.now()-o>1e4){let e=await d();console.log("[WORKER] ♥ Loop #"+t.loopCount+" | File: "+e+" | Affich\xe9: "+(n||"IDLE")),o=Date.now()}try{let e=await R();if(!e){null!==n&&(console.log("[WORKER] File vide d\xe9tect\xe9e"),await E(),n=null,r=0),await c(500);continue}e.entry.id!==n&&(console.log("[WORKER] ────────────────────────────────────────"),console.log("[WORKER] NOUVELLE QUESTION"),console.log("[WORKER] ID: "+e.entry.id),console.log("[WORKER] User: "+e.entry.userId),console.log("[WORKER] ────────────────────────────────────────"),await D(e.entry),n=e.entry.id,r=Date.now(),console.log("[WORKER] Countdown 30s d\xe9marr\xe9"));let t=Date.now()-r;if(3e4-t<=0){console.log("[WORKER] Temps \xe9coul\xe9 pour question ID="+n);let e=await g();e?console.log("[WORKER] ✓ Question supprim\xe9e: ID="+e.id):console.log("[WORKER] ⚠ LPOP retourn\xe9 null");let t=await d();console.log("[WORKER] Questions restantes: "+t),r=0,await c(200)}else await c(500)}catch(e){console.error("[WORKER] ══════════ ERREUR ══════════"),console.error("[WORKER]",e),n=null,r=0,await c(1e3)}}}function h(){let e=u();if(e.started){console.log("[WORKER] D\xe9j\xe0 d\xe9marr\xe9 (instance: "+e.instanceId+")");return}e.started=!0,e.instanceId=`w-${process.pid}-${r().randomBytes(3).toString("hex")}`,console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] ═══════════ D\xc9MARRAGE DU WORKER ═══════════════════"),console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] Instance: "+e.instanceId),console.log("[WORKER] PID: "+process.pid),console.log("[WORKER] Dur\xe9e affichage: 30000ms"),console.log("[WORKER] Intervalle poll: 500ms"),f(e.instanceId)}function I(){let e=u();return{started:e.started,instanceId:e.instanceId,loopCount:e.loopCount,lastActivity:e.lastActivity,lastActivityAgo:e.lastActivity?Date.now()-e.lastActivity:null}}},9534:(e,t,o)=>{o.d(t,{T8:()=>r,jJ:()=>s,u0:()=>i});var n=o(2197);let r=null,s=!1;try{(r=new n.Redis({host:process.env.REDIS_HOST||"localhost",port:parseInt(process.env.REDIS_PORT||"6379",10),retryStrategy:e=>e>3?(console.error("[REDIS] Max retry attempts reached. Redis unavailable."),null):Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("connect",()=>{console.log("[REDIS] Connected successfully"),s=!0}),r.on("error",e=>{console.error("[REDIS ERROR]",e.message),s=!1})}catch(e){console.error("[REDIS] Failed to initialize:",e),r=null,s=!1}async function i(e,t,o){if(!r)return console.warn(`[REDIS FALLBACK] ${o} - Redis client not initialized, using fallback`),t;try{return await e()}catch(e){return console.error(`[REDIS ERROR] ${o} failed:`,e),t}}},1748:(e,t,o)=>{o.d(t,{K:()=>s,z:()=>r});let n=process.env.WLED_URL||"http://192.168.2.120/json/state";async function r(e){if(!n)return console.warn("[WLED] ⚠️ No URL configured, SKIPPING"),!1;let t=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(),o=t.length>64?`${t.slice(0,61).trimEnd()}...`:t;console.log("[WLED] Sending text:",{url:n,text:o,textLength:o.length});try{let e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({on:!0,bri:255,mainseg:0,seg:[{id:0,start:0,stop:32,startY:0,stopY:8,grp:1,spc:0,of:0,on:!0,frz:!1,bri:255,cct:127,set:0,n:o,col:[[77,166,255],[0,0,0],[0,0,0]],fx:122,sx:200,ix:128,pal:0,c1:0,c2:128,c3:16,sel:!0,rev:!1,mi:!1,rY:!1,mY:!1,tp:!1,o1:!1,o2:!1,o3:!1,si:0,m12:0}]}),signal:AbortSignal.timeout(5e3)}),t=await e.text().catch(()=>"");if(!e.ok)return console.error("[WLED] ❌ HTTP Error:",e.status,t.substring(0,200)),!1;if(console.log("[WLED] ✓ Response OK:",e.status),t)try{let e=JSON.parse(t);console.log("[WLED] Response state:",{on:e.on,bri:e.bri,seg0_n:e.seg?.[0]?.n?.substring(0,30)})}catch{console.log("[WLED] Response (raw):",t.substring(0,100))}return!0}catch(e){return console.error("[WLED] ❌ Network error:",e),!1}}async function s(){let e=n?.replace("/json/state","/json/info");if(!e)return!1;try{let t=await fetch(e,{method:"GET",signal:AbortSignal.timeout(3e3)});if(t.ok){let e=await t.json();return console.log("[WLED] Connection test OK:",{name:e.name,ver:e.ver,ip:e.ip}),!0}return!1}catch{return console.error("[WLED] Connection test FAILED"),!1}}console.log("[WLED] ═══════════════════════════════════════════"),console.log("[WLED] Configuration:"),console.log("[WLED]   URL:",n),console.log("[WLED] ═══════════════════════════════════════════")}};var t=require("../../../webpack-runtime.js");t.C(e);var o=e=>t(t.s=e),n=t.X(0,[276,197,972],()=>o(1288));module.exports=n})();
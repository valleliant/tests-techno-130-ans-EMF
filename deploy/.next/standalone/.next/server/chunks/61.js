"use strict";exports.id=61,exports.ids=[61],exports.modules={3676:(e,o,t)=>{t.d(o,{c:()=>r});let n=process.env.NUMBER_DISPLAY_URL||"http://192.168.2.130/data",l=process.env.NUMBER_DISPLAY_TOKEN||"";async function r(e){if(!n)return console.warn("[NUM-DISPLAY] ⚠️ No URL configured, SKIPPING"),!1;if(!l)return console.warn("[NUM-DISPLAY] ⚠️ No token configured (NUMBER_DISPLAY_TOKEN env var), SKIPPING"),!1;let o=Math.max(0,Math.min(255,Number.isFinite(e)?Math.trunc(e):255)),t=`token=${encodeURIComponent(l)}&datain=${o}`;console.log("[NUM-DISPLAY] Sending request:",{url:n,id:o,bodyLength:t.length});try{let e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:t,signal:AbortSignal.timeout(3e3)}),o=await e.text().catch(()=>"");if(!e.ok)return console.error("[NUM-DISPLAY] ❌ HTTP Error:",e.status,o),!1;return console.log("[NUM-DISPLAY] ✓ Response OK:",e.status,o),!0}catch(e){return console.error("[NUM-DISPLAY] ❌ Network error:",e),!1}}console.log("[NUM-DISPLAY] ═══════════════════════════════════════════"),console.log("[NUM-DISPLAY] Configuration:"),console.log("[NUM-DISPLAY]   URL:",n),console.log("[NUM-DISPLAY]   Token configured:",l?"YES ("+l.length+" chars)":"NO ⚠️"),console.log("[NUM-DISPLAY] ═══════════════════════════════════════════")},3061:(e,o,t)=>{t.d(o,{S:()=>f,l:()=>L});var n=t(6005),l=t.n(n),r=t(9534),s=t(3676),i=t(1748);let a="questions:queue";function c(){return globalThis.__queueWorkerState||(globalThis.__queueWorkerState={started:!1,instanceId:"",loopCount:0,lastActivity:0}),globalThis.__queueWorkerState}function u(e){return new Promise(o=>setTimeout(o,Math.max(0,e)))}function R(e){try{return JSON.parse(e)}catch{return null}}async function E(){let e=await (0,r.u0)(async()=>{if(!r.T8)throw Error("Redis not initialized");return r.T8.lindex(a,0)},null,"LINDEX");if(!e)return null;let o=R(e);return o?{raw:e,entry:o}:(console.warn("[WORKER] JSON invalide en t\xeate, suppression..."),await (0,r.u0)(async()=>{if(!r.T8)throw Error("Redis not initialized");await r.T8.lpop(a)},void 0,"LPOP invalid"),null)}async function g(){return(0,r.u0)(async()=>{if(!r.T8)throw Error("Redis not initialized");return r.T8.llen(a)},0,"LLEN")}async function d(){let e=await (0,r.u0)(async()=>{if(!r.T8)throw Error("Redis not initialized");return r.T8.lpop(a)},null,"LPOP");return e?R(e):null}async function D(){console.log("[WORKER] ══> Envoi IDLE aux ESP32"),console.log("[WORKER] ══> R\xe9sultat IDLE: WLED="+(await (0,i.z)("ECOLE DES METIERS DE FRIBOURG")?"✓":"✗")+", Display="+(await (0,s.c)(255)?"✓":"✗"))}async function p(e){let o=parseInt(e.id,10),t=isNaN(o)?255:o;console.log("[WORKER] ══> Envoi QUESTION ID="+e.id+" au WLED + ID au display 8bits"),console.log("[WORKER] ══> R\xe9sultat: WLED="+(await (0,i.z)(e.question)?"✓":"✗")+", Display="+(await (0,s.c)(t)?"✓":"✗")+" (ID="+t+")")}async function I(e){let o=e.reponse_detaillee??e.question;console.log("[WORKER] ══> Envoi R\xc9PONSE D\xc9TAILL\xc9E ID="+e.id+" au WLED"),console.log("[WORKER] ══> R\xe9sultat: WLED="+(await (0,i.z)(o)?"✓":"✗"))}async function O(e){let o=c(),t=Date.now(),n=null,l=null,r=0,i=!1,a=!1;for(console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] Boucle d\xe9marr\xe9e - Instance:",e),console.log("[WORKER] ═══════════════════════════════════════════════════");;){if(o.loopCount++,o.lastActivity=Date.now(),Date.now()-t>1e4){let e=await g();console.log("[WORKER] ♥ Loop #"+o.loopCount+" | File: "+e+" | Affich\xe9: "+(n||"IDLE")),t=Date.now()}try{let e=await E();if(!e){null!==n&&(console.log("[WORKER] File vide d\xe9tect\xe9e"),await D(),n=null,l=null,r=0,i=!1,a=!1),await u(500);continue}e.entry.id!==n&&(console.log("[WORKER] ────────────────────────────────────────"),console.log("[WORKER] NOUVELLE QUESTION"),console.log("[WORKER] ID: "+e.entry.id),console.log("[WORKER] User: "+e.entry.userId),console.log("[WORKER] ────────────────────────────────────────"),await p(e.entry),n=e.entry.id,l=e.entry,r=Date.now(),i=!1,a=!1,console.log("[WORKER] Countdown 67s d\xe9marr\xe9 (ID: 0-1s, Question: 0-33.5s, R\xe9ponse: 33.5-67s)"));let o=Date.now()-r;if(!i&&r>0&&o>=1e3&&(console.log("[WORKER] 1s \xe9coul\xe9e, envoi 255 au display 8 bits (ID captur\xe9)"),await (0,s.c)(255),i=!0),!a&&l&&r>0&&o>=33500&&(console.log("[WORKER] Question termin\xe9e, envoi de la R\xc9PONSE au WLED"),await I(l),a=!0),67e3-o<=0){console.log("[WORKER] Temps \xe9coul\xe9 pour question ID="+n);let e=await d();e?console.log("[WORKER] ✓ Question supprim\xe9e: ID="+e.id):console.log("[WORKER] ⚠ LPOP retourn\xe9 null");let o=await g();console.log("[WORKER] Questions restantes: "+o),r=0,await u(200)}else await u(500)}catch(e){console.error("[WORKER] ══════════ ERREUR ══════════"),console.error("[WORKER]",e),n=null,l=null,r=0,i=!1,a=!1,await u(1e3)}}}function L(){let e=c();if(e.started){console.log("[WORKER] D\xe9j\xe0 d\xe9marr\xe9 (instance: "+e.instanceId+")");return}e.started=!0,e.instanceId=`w-${process.pid}-${l().randomBytes(3).toString("hex")}`,console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] ═══════════ D\xc9MARRAGE DU WORKER ═══════════════════"),console.log("[WORKER] ═══════════════════════════════════════════════════"),console.log("[WORKER] Instance: "+e.instanceId),console.log("[WORKER] PID: "+process.pid),console.log("[WORKER] Dur\xe9e affichage: 67000ms"),console.log("[WORKER] Intervalle poll: 500ms"),O(e.instanceId)}function f(){let e=c();return{started:e.started,instanceId:e.instanceId,loopCount:e.loopCount,lastActivity:e.lastActivity,lastActivityAgo:e.lastActivity?Date.now()-e.lastActivity:null}}},9534:(e,o,t)=>{t.d(o,{T8:()=>l,jJ:()=>r,u0:()=>s});var n=t(2197);let l=null,r=!1;try{(l=new n.Redis({host:process.env.REDIS_HOST||"localhost",port:parseInt(process.env.REDIS_PORT||"6379",10),retryStrategy:e=>e>3?(console.error("[REDIS] Max retry attempts reached. Redis unavailable."),null):Math.min(50*e,2e3),maxRetriesPerRequest:3})).on("connect",()=>{console.log("[REDIS] Connected successfully"),r=!0}),l.on("error",e=>{console.error("[REDIS ERROR]",e.message),r=!1})}catch(e){console.error("[REDIS] Failed to initialize:",e),l=null,r=!1}async function s(e,o,t){if(!l)return console.warn(`[REDIS FALLBACK] ${t} - Redis client not initialized, using fallback`),o;try{return await e()}catch(e){return console.error(`[REDIS ERROR] ${t} failed:`,e),o}}},1748:(e,o,t)=>{t.d(o,{K:()=>r,z:()=>l});let n=process.env.WLED_URL||"http://192.168.2.120/json/state";async function l(e){if(!n)return console.warn("[WLED] ⚠️ No URL configured, SKIPPING"),!1;let o=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toUpperCase(),t=(o.length>64?`${o.slice(0,61).trimEnd()}...`:o).padEnd(64," ");console.log("[WLED] Sending text:",{url:n,text:t,textLength:t.length});let l={on:!0,bri:255,transition:0,mainseg:0,seg:[{id:0,start:0,stop:224,startY:0,stopY:16,grp:2,spc:0,of:0,on:!0,frz:!1,bri:255,cct:127,set:0,n:t,col:[[149,255,0],[0,0,0],[0,0,0]],fx:122,sx:255,ix:128,pal:11,c1:0,c2:128,c3:16,sel:!0,rev:!1,mi:!1,rY:!1,mY:!1,tp:!1,o1:!1,o2:!1,o3:!1,si:0,m12:0},...Array.from({length:31},()=>({stop:0}))]};try{let e=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(5e3)}),o=await e.text().catch(()=>"");if(!e.ok)return console.error("[WLED] ❌ HTTP Error:",e.status,o.substring(0,200)),!1;if(console.log("[WLED] ✓ Response OK:",e.status),o)try{let e=JSON.parse(o);console.log("[WLED] Response state:",{on:e.on,bri:e.bri,seg0_n:e.seg?.[0]?.n?.substring(0,30)})}catch{console.log("[WLED] Response (raw):",o.substring(0,100))}return!0}catch(e){return console.error("[WLED] ❌ Network error:",e),!1}}async function r(){let e=n?.replace("/json/state","/json/info");if(!e)return!1;try{let o=await fetch(e,{method:"GET",signal:AbortSignal.timeout(3e3)});if(o.ok){let e=await o.json();return console.log("[WLED] Connection test OK:",{name:e.name,ver:e.ver,ip:e.ip}),!0}return!1}catch{return console.error("[WLED] Connection test FAILED"),!1}}console.log("[WLED] ═══════════════════════════════════════════"),console.log("[WLED] Configuration:"),console.log("[WLED]   URL:",n),console.log("[WLED] ═══════════════════════════════════════════")}};